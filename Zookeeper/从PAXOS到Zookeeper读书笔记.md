# Zookeeper

## 1. ACID与CAP

## 2. 分布式一致性协议

常见的分布式一致性协议有: 两阶段提交协议，三阶段提交协议，向量时钟，RWN协议，paxos协议，Raft协议。 

### 2.1 两阶段提交协议(2PC)

两阶段提交协议，简称2PC，是比较常用的解决分布式事务问题的方式，要么所有参与进程都提交事务，要么都取消事务，即实现ACID中的原子性(A)的常用手段。

#### 2.1.1 提交流程

* **提交事务请求**

  * **事务询问**：协调者向所有参与者发送事务内容，询问是否可以提交，等待个参与者响应；
  * **事务执行**：各参与者执行事务，将Undo、Redo信息记入日志；
  * **反馈响应**：参与者成功执行事务则反馈Yes，否则反馈No。

  这一阶段也被称为投票阶段。

* **执行事务提交**

  * **执行事务提交**：如果所有参与者都反馈Yes，则发送事务提交请求。参与者收到Commit请求后正式执行提交，提交完成反馈Ack消息。协调者收到所有参与者反馈的Ack消息后完成事务。
  * **中断事务**：如果任一个参与者反馈了No响应，或等待超时后协调者无法接收所有参与者的反馈响应，那么就会发送回滚请求Rollback。参与者完成回滚后发送Ack。

简单来说**二阶段将事务提交过程分为投票和执行两个阶段，是一个强一致性的算法。**

#### 2.1.2 优缺点

优点：原理简单、实现方便
缺点：同步阻塞、单点问题、脑裂、太过保守

### 2.2 三阶段提交协议(3PC)

3PC就是在2PC基础上将2PC的提交阶段细分位两个阶段：预提交阶段和提交阶段

#### 2.2.1 提交流程

* **CanCommit**

  * 事务询问
  * 反馈询问

* **PreCommit**

  根据CanCommit阶段反馈，执行事务预提交或中断事务

* **doCommit**

  根据PreCommit阶段反馈执行提交或中断事务

在进入三阶段后，如果协调者出现问题或网络故障，导致参与者无法及时接收到协调者的请求，参与者会在等待超时后继续进行事务提交。

#### 2.2.2 优缺点

优点：相较于2PC，降低了阻塞范围，并能在单点故障后继续达成一致。
缺点：引入新的问题，参与者接收到preCommit消息后如果发生网络故障，仍然会继续提交，会造成数据不一致。

### 2.3 Paxos算法

一种基于消息传递且具有高度容错性的一致性算法，是目前解决分布式一致性问题最有效的算法之一。

 https://chuansongme.com/n/2189245 

#### 2.3.1 提交流程

* **第一阶段 Prepare**

  * **P1a：Proposer 发送 Prepare**

    Proposer 生成全局唯一且递增的提案 ID（Proposalid，以高位时间戳 + 低位机器 IP 可以保证唯一性和递增性），向 Paxos 集群的所有机器发送 PrepareRequest，这里无需携带提案内容，只携带 Proposalid 即可。

  - **P1b：Acceptor 应答 Prepare**
    Acceptor 收到 PrepareRequest 后，做出“两个承诺，一个应答”。

    **两个承诺：**

    - 第一，不再应答 Proposalid 小于等于（注意：这里是 <= ）当前请求的 PrepareRequest；
    - 第二，不再应答 Proposalid 小于（注意：这里是 < ）当前请求的 AcceptRequest

    **一个应答：**

    - 返回自己已经 Accept 过的提案中 ProposalID 最大的那个提案的内容，如果没有则返回空值;

    注意：这“两个承诺”中，蕴含两个要点：就是应答当前请求前，也要按照“两个承诺”检查是否会违背之前处理 PrepareRequest 时做出的承诺；应答前要在本地持久化当前 Propsalid。

- **第二阶段 Accept**

  - **P2a：Proposer 发送 Accept**
    “提案生成规则”：Proposer 收集到多数派应答的 PrepareResponse 后，从中选择proposalid最大的提案内容，作为要发起 Accept 的提案，如果这个提案为空值，则可以自己随意决定提案内容。然后携带上当前 Proposalid，向 Paxos 集群的所有机器发送 AccpetRequest。

  - **P2b：Acceptor 应答 Accept**

    Accpetor 收到 AccpetRequest 后，检查不违背自己之前作出的“两个承诺”情况下，持久化当前 Proposalid 和提案内容。最后 Proposer 收集到多数派应答的 AcceptResponse 后，形成决议。

#### 2.4 ZAB协议（Zookeeper原子消息协议）

ZAB是一种特别为Zookeeper实现的崩溃可恢复的原子消息广播算法。

基于ZAB，Zookeeper使用一个单一的主进程来接收并处理客户端的所有事务请求，并采用ZAB协议将服务器数据的状态变更以事务Proposal的形式广播到所有的副本进程上去。

> 所有的事务请求必须由一个全局唯一的服务器来协调处理，即Leader；
> 而其他服务器作为Follower。Leader将一个客户端事务请求转化为一个事务Proposal，并将其分发所有Follower。之后Leader等待所有Follower的反馈，超过半数正确则会向所有Follower分发Commit消息。

Zookeeper

## 3. Zookeeper

Zookeeper 是 一个典型的分布式数据一致性的解决方案。

### 3.1 Zookeeper的典型应用场景

数据发布/订阅、负载均衡、命名服务、分布式协调/通知、集群管理、Master、分布式锁、分布式队列。

### 3.2 Zookeeper分布式一致性特性

* 顺序一致性：同一个客户端发出的请求会严格的按顺序被应用到Zookeeper中去。
* 原子性：所有事务请求的处理都是原子的。
* 单一视图：无论客户端连接的是哪个Zookeeper服务器，其看到的服务端数据模型都是一致的。
* 可靠性：一旦服务端成功应用了一个事务，其影响会一直被保留下来。
* 实时性：Zookeeper仅能保证在一定时间内，客户端最终一定能从服务端读到最新的数据。

### 3.3 Zookeeper设计目标

* 简单的数据模型：Znode数据节点
* 可以构建集群
* 顺序访问：客户端的每一个请求，Zookeeper都会分配全局递增的ID
* 高性能：数据存储于内存中

### 3.4 Zookeeper基本架构

#### 3.4.1 集群角色  Leader，Follower，Observer

#### 3.4.2 会话

#### 3.4.3 数据节点Znode

#### 3.4.4 版本

#### 3.4.5 Watcher

#### 3.4.6 ACL




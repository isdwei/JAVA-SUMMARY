# TCPIP协议

## 一、TCP/IP协议基础知识

### 1. 网络分层模型

#### 1.1 OSI七层参考模型

| 七层参考模型 | 作用                                                         | 举例                                                         |
| ------------ | ------------------------------------------------------------ | ------------------------------------------------------------ |
| 应用层       | 正对特定应用的协议                                           |                                                              |
| 表示层       | 设备固有数据格式和网络标准数据格式的转换                     |                                                              |
| 会话层       | 通信管理，负责建立断开通信连接                               |                                                              |
| 传输层       | 管理两个节点间的可靠数据传输，只在通信双方节点上处理，无需再路由器上处理 | TCP，UDP，SCTP，DCCP                                         |
| 网络层       | 地址管理和路由选择                                           | 路由器（根据IP地址进行处理，可以连接不同的数据链路）IPv4，IPv6.. |
| 数据链路层   | 互联设备之间传送和识别数据帧                                 | 网桥（根据数据帧的内容转发给相邻的网络，两者速度可以不同）（根据MAC地址进行处理） |
| 物理层       | 负责比特流与电压高低灯光闪灭的互换                           | 中继器（信号放大再生）（不能在传输速度不同的网络间转发）     |

#### 1.2 TCP/IP协议分层模型

| 四层参考模型 | 作用                                                   |      |
| ------------ | ------------------------------------------------------ | ---- |
| 应用层       | 包含了OSI参考模型中的应用层，表示层，会话层，WWW、HTTP |      |
| 传输层       | TCP、UDP                                               |      |
| 互联网层     | IP、ICMP、ARP                                          |      |
| 数据链路层   |                                                        |      |
| 物理层       | 负责数据传输的硬件                                     |      |

### 2. 一些名词解释

* 包：全能型术语
* 帧：数据链路层中包的单位
* 数据：是IP和UDP等网络层以上分层中包的单位
* 段：表示TCP数据流中的信息
* 消息：应用协议中数据的单位

## 二、数据链路层

### 1. 数据链路相关技术

TCP/IP协议对数据链路层与物理层未作定义，这是以这两层的功能是透明的为前提。

数据链路层协议定义了通过通信媒介互联的设备之间传输的规范。

#### 1.1 MAC地址

MAC地址用于识别数据链路中互连的节点。

MAC地址长48bit，MAC地址一般烧入网卡的ROM中，任一网卡的MAC地址都是唯一不可重复的。

MAC地址：70-BC-10-74-9C-C9

‭					01**110000-10111100-00010000**-01110100-10011100-11001001‬

* 第1位：单播地址（0）/多播地址（1）
* 第2位：全局地址（0）/本地地址（1）
* 3-24位：IEEE管理，保证各厂商不重复
* 25-48位：各厂商管理，保证产品不重复

> **半双工与全双工通信**：
> 		半双工：只发送或只接收
> 		全双工：同时发送接收

#### 1.2 根据MAC地址转发

在使用同轴电缆的以太网等介质共享网络中，交换集线器/以太网交换机，即网桥，根据数据链路层中的每个帧的目标MAC地址，决定从哪个网络接口发送数据。这时所参考的用于记录发送接口的表叫**转发表**。

**转发表的自学过程**：数据链路层的每个通过点在接到包时，会从中将源MAC地址与曾经接收该地址发送的数据包的接口作为对应关系记录到转发表中。

当设备增加时，转发表也随之变大，当连接多个终端时有必要将网络分为多个数据链路，采用类似网络层IP地址一样的分层管理模式。

#### 1.3 环路检测技术

**环路**

* 缺点：通过网桥连接网络时，最坏的情况数据帧在环路中被持续转发，数据帧越来越多导致网络瘫痪。
* 优点：分散网络流量，提高容灾能力

**环路检测技术**：

* 生成树方式：每个网桥必须在1~10秒内互相交换BPDU（Bridge Protocol Data Unit）包，判断哪些端口使用那些不使用，以便消除环路。
* 源路由法：判断发送数据的源地址是通过哪个网桥传输的，并将帧写入RIF（Routing Information Field），网桥根据这个RIF发送帧给目标地址。

#### 1.4 VLAN

VLAN通过对某一台交换机按端口区分多个网段，从而区分了广播数据传播范围，减少了网路负载并提高了网络安全性。

### 2. 以太网

数据链路层包的单位叫帧。

#### 2.1 以太网帧格式

以太网前端有一个前导码部分，8个字节，64位。

前导码末尾8位是11，称为SFD域，在这个域后就是以太网本体。

以太网帧本体前端是以太网首部，占14个字节，分别是6个字节的目标MAC地址，6个字节的源MAC地址以及来个字节的上层协议类型。

紧随帧头后面的是数据。一个数据帧所能容纳最大数据范围是46~1500个字节。帧尾是4个字节的FCS（帧检验序列），错误帧会被直接丢弃。

![1587549965751](C:\Users\weitu\AppData\Roaming\Typora\typora-user-images\1587549965751.png)

> 数据链路层进一步细分可分为介质访问控制层（MAC）和逻辑链路控制层（LLC），介质访问控制层根据以太网或FDDI等不同数据链路所特有的首部信息进行控制，逻辑链路从根据不同数据链路所共有的帧头信息控制。

## 三、网络层（IP协议）

互联网层由IP（Internet Protocol）与ICMP（Internet Control Message Protocol）两个协议组成。

网络层主要实现“终端节点之间的通信”，网络层可以跨越多个数据链路实现数据包的传输。

数据链路层负责两个直连设备间的通信，而网络层的IP则在没有直连的两个网络间通信传输。

### 1. IP基础知识

#### 1.1 IP地址属于网络层地址

TCP/IP通信中所有主机和路由器都必须设定自己的IP地址。而在网桥、交换集线器这种物理层或数据链路层的设备中则不需要IP地址。

#### 1.2 路由控制（Routing）

路由控制是指将分组数据发送到最终目标地址的功能。

**路由控制表**：所有主机都维护了一张路由控制表（Routing Table），该表记录IP数据在下一步应该发给哪个路由。

#### 1.3 IP特性

**IP面向无连接**：简化，提速。
IP提供尽力服务，并不做最终收到与否的验证。

### 2. IP地址

#### 2.1 IP地址构成

IPv4地址由32位正整数构成：网络地址+主机标识。IP地址分为四个级别。

* A类：首位为0的地址，1~8为是网络标识，即0.0.0.0-127.0.0.0；
* B类：前两位是10的地址，1~16位是网络标识，即128.0.0.1-191.255.0.0；
* C类：前两位是110的地址，1~24位是网络标识，即192.168.0.0-239.255.255.0；
* B类：前两位是1110的地址，1~32位是网络标识，即224.0.0.1-239.255.255.255，没有主机标识，常被用作多播。

IP地址不可为0.0.0.0（IP地址不可获知）或1.1.1.1（多播）

IPv6具有128位，8个字节

#### 2.2 广播地址

广播地址用于在同一个链路中发送广播数据。IP地址中主机部分全设置为1，就形成的广播地址。
广播无法穿透路由。

* 本地广播：本网络内广播的地址
* 直接广播：不同网络间的广播

> 多播：可以穿透路由

#### 2.3 子网掩码

为了避免IP地址浪费，增加子网掩码。

子网掩码：32位，它对应的网络部分标识全为1，对应IP地址主机标识部分全为0.由此一个IP地址不再受限于自己的类别

#### 2.4 CIDR与VLSM

CIDR：无类型域间选路，解决全局IP地址不够用的问题

#### 2.5 全局地址与私有地址

私有IP地址：

* 10/8
* 172.16/12
* 192.168/16

私有IP通过NAT与全局地址的主机通信

### 3. 路由控制

Ip地址的网络部分用于路由控制。每一路由控制表中记录的网络地址与下一步应该发送至路由器的地址。

* 默认路由：可以匹配任一地址，0.0.0.0/0
* 主机路由：整个IP地址的所有位都将参与路由，进行主机路由意味着要基于主机上网卡配置的IP地址本身，而不是基于该地址的网络地址部分进行路由，主机路由多被用于不希望通过网络地址路由情况。IP地址/32
* 环回地址：同一台计算机上的程序之间进行网络通讯时默认的地址，127.0.0.1

### 4. IP分割处理和路径MTU发现

MTU：MTU是指最大传输单元

IP分片：在网络传输的过程中，由于不同数据链路的MTU不同，当一个IP数据报无法在一个帧当中完成发送时，路由器就会将IP数据报分片发送。但是分片机制会使路由器的负荷加重。

路径MTU：从发送端主机到接收端主机之间不需要分片时最大MTU的大小。

路径MTU发现原理：发送端主机发送IP数据报时，将首部的禁止标志为设置为1，根据这个标志位，途中的路由器即使遇到需要分片处理才能处理的大包，也不会进行分片，而是将其丢弃，随后通过一个ICMP的不可达消息，数据链路上的MTU值发送给主机。下一次，从发送给同一个目标主机的IP数据报获得ICMP所通知的MTU值以后，将它设置为当前MTU，直到数据报被发送到目标主机为止没有收到任何ICMP。

### 5. IP相关技术

#### 5.1 DNS

DNS系统是一个可以有效管理主机名和IP地址之间对应关系的系统。

DNS查询：当一台计算机，想要访问一个网站时，DNS的查询流程如下：

* 首先解析器向域名服务器进行查询，处理接收到这个请求的域名服务器会首先在自己的数据库中查找，如果该域名的IP地址存在，那么就直接返回，如果没有，就会再向上一层根域名服务器进行查询处理。因此如图所示从更开始只对这棵树开始呢，按照顺序进行遍历直到找到与指定的域名服务器，并用这个域名服务器返回想要的数据。
* 解析器和域名服务器将最新了解到的信息暂时保存在缓存里，这样可以减少每次查询时的性能消耗。

不同的解析记录：

* A类型  ，主机名的IP地址，IPv4
* CNAME，主机别名对应的规范名称，
* PTR，IP地址的反向解析，从IP地址检索主机名。

#### 5.2 ARP & RARP

**ARP（Address Resolution Protocol，地址解析协议 ）机制**：以目标IP地址为线索，用来定位下一个应该接收数据分包的网络设备对应的MAC地址。如果目标主机不在同一链路时可以通过IP查找下一跳路由器的MAC地址。

**ARP的工作机制**：一个IP地址会广播ARP请求包，其中包含了其想要获取MAC地址的IP地址，而目的地收到请求包后会将自己的MAC地址填入其中返回给主机。IP可以动态地进行地址解析，所以在TCP/IP网络构造和通信中只要有IP地址即可。

IP协议是将IP地址和MAC地址的协议。

**RARP（Reverse Address Resolution Protocol）**：从MAC地址定位IP地址的协议

#### 5.3 ICMP

ICMp提供验证网络设置是否正确的功能。IP通信中具体某个IP包未能到达目的地址的的原因将由ICMP负责通知。

ICMP消息包括：不可达消息、重定向消息、超时消息、重回消息

#### 5.4 DHCP

DHCP（Dynamic Host Configuration Protocol）：通过DHCP服务器自动分配IP。

架设一台或多台DHCP服务器，当DHCP服务器发现包时，会向客户端指定IP地址和子网掩码。

#### 5.5 NAT

NAT（Network Address Translator）：将本地网络中的私有IP地址转换位全局IP地址。

NAT内部自动生成一张地址转换表

#### 5.6 IP隧道

IP隧道可以将IPv6包统合为一个数据再加上IPv4的首部进行转发。

在网络层首部后继续追加网络层首部的通信方法叫做“IP隧道”。

## 四、传输层（TCP & UDP）

TCP（传输控制协议）：面向连接的可靠的流协议
UDP（用户数据协议）：不可靠的数据报协议
运输层协议是通过在端系统而不是网络路由器实现的。在发送方，运输层将接收到的来自应用进程的报文转换成运输层报文段（Segment），并为其加上运输层首部，传递给网络层。

运输层为应用程序提供了逻辑通信，而网络层为主机提供了逻辑通信。

### 1.多路分解与多路复用

#### 1.1 多路复用的要求

* 套接字有唯一标识符
* 每个报文段有特殊字符来指示该报文段所要交付的套接字：源端口号和目的端口号

#### 1.2 套接字

TCP套接字是由一个四元组（源IP，源端口，目的IP，目的端口）标识的，主机使用全部四个值将报文定向（多路分解）到相应的套接字。

### 2. UDP协议

#### 2.1 UDP报文段

UDP报文段包括：源端口号，目的端口号，长度，校验和，应用数据

### 3. TCP协议

#### 3.1 可靠数据传输原理

**选择重传（SR）协议**：发送方仅重传它怀疑接收方出错的分组，避免不必要的重传。

**发送方**：

* 从上层接受应用数据：检查下一个可用于该分组的序号，如果序号在窗口内则打包发送，否则缓存或返回上层；
* 超时：每个分组具有独立的定时器；
* 收到ACK：如果收到ACK，且分组序号在窗口内，则SR发送方讲被确认的分组标记为已接收。如果该分组的序号等于send_base，则窗口向前移动到具有最小序号的未确认分组处。

**接收方**：

* **正确接收**：接收方接受到在当前工作窗口内的分组时，将向发送放发送ACK，如果该分组是以前没收到分组则缓存，如果该分组的学号等于接收窗口的基序号，那么这个窗户将向前移动到具有最小序号的未接受分组处。
* **序号在前一个窗口中的分组被接收**：重复接收时也必须返回一个ACK，以免发送方的分组窗口不可向前继续滑动。

**窗口的长度必须小于或等于序号空间大小的一半。**

##### 可靠传输机制及其用途的总结。

| 机制         | 用途与说明                                                   |
| ------------ | ------------------------------------------------------------ |
| 检验和       | 用于检测在一个传输分组中的比特错误                           |
| 定时器       | 用于检测超时重传一个分组，可能接收方会收到冗余拷贝           |
| 序号         | 用于为从发送方流向接收方数据分组按顺序编号，为了避免序号重复使用，TCP网络中一个序号的寿命被假定在三分钟。 |
| ACK/NAK      | 用于接收方告知发送方是否正确接收到                           |
| 窗口、流水线 | 允许一次发送多个分组但未被确认。提高发送方的利用率，窗口长度可根据接收方接受和缓存报文的能力和网络中的拥塞情况来进行设置。 |

#### 3.2 面向连接的运输：TCP

可靠、全双工、点对点、只在端系统中存在